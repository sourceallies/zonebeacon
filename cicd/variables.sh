#!/bin/bash

decrypt() {
    toDecode=$1; #variable to decode
    tempBinaryFile="./tempBinaryFile"; # Temporary file to store the encrypted secret

    if [ "$toDecode" = "" ]; then # Don't try to decrypt a placeholder
        echo $toDecode;
        return 0
    fi

    touch $tempBinaryFile;
    echo $toDecode | base64 --decode > $tempBinaryFile;
    result=$(aws kms decrypt --ciphertext-blob fileb://$tempBinaryFile --query Plaintext --output text | base64 --decode);
    rm $tempBinaryFile;

    echo $result;
}

export ENCRYPTED_KEYSTORE_JKS='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'
export ENCRYPTED_KEYSTORE_PASSWORD='AQICAHiU94zrLYNUSGVArF52ziz3345yixl9BFRI86oJyZWqrgE9tb4ZV0Q8bqXMPo/l1vbnAAAAfjB8BgkqhkiG9w0BBwagbzBtAgEAMGgGCSqGSIb3DQEHATAeBglghkgBZQMEAS4wEQQMn1l6fDzcyLJ7HORdAgEQgDtLE6xFy4xY2L0/rI0BZ02OtxJNcmZWlgFKAes0HzcP8tvYmlogmj4Jq5YiGdxCkS+iSoqgUqd+qmmubw=='
export ENCRYPTED_KEY_ALIAS='AQICAHiU94zrLYNUSGVArF52ziz3345yixl9BFRI86oJyZWqrgE8LOdbg9DbFoU3p+kRg79PAAAAdzB1BgkqhkiG9w0BBwagaDBmAgEAMGEGCSqGSIb3DQEHATAeBglghkgBZQMEAS4wEQQM8RRTQbEFgFwiQAbYAgEQgDQ1CQSyJav8hdpXlpEp0si2VfOitzACiFsKy2UQrEjG6bnUslU5hN1zjBp6lc7rG/5fHodG'
export ENCRYPTED_KEY_PASSWORD='AQICAHiU94zrLYNUSGVArF52ziz3345yixl9BFRI86oJyZWqrgEKJQXkZXEdkowAhGqS0O2LAAAAfjB8BgkqhkiG9w0BBwagbzBtAgEAMGgGCSqGSIb3DQEHATAeBglghkgBZQMEAS4wEQQMZO3F67jxfQyrya96AgEQgDs3ToW3R6XKnu0dXQwxZOyJEsKMf5BGcaTkLUJJosCmBbfzK6a1ktKlFjj7fwW1NdG7u9xbl8nPPOqb+Q=='
export ENCRYPTED_NEARBY='AQICAHiU94zrLYNUSGVArF52ziz3345yixl9BFRI86oJyZWqrgFOSV699B6aMWnbIStJZwB4AAAAhjCBgwYJKoZIhvcNAQcGoHYwdAIBADBvBgkqhkiG9w0BBwEwHgYJYIZIAWUDBAEuMBEEDFROCoMiSQ6zVUPcdAIBEIBCe7saJ80VMjpzEGM/xhe9Oct1pLIiEaOsSItGh3R65LgcJK0RVHmOHKLtI5C3+3vmyeqXI8cjUd4t9xfYp5ANasrz'
export ENCRYPTED_COVERALLS_REPO_TOKEN='AQICAHiU94zrLYNUSGVArF52ziz3345yixl9BFRI86oJyZWqrgG5JNBVjuGJ54PL2FqF2VCVAAAAfzB9BgkqhkiG9w0BBwagcDBuAgEAMGkGCSqGSIb3DQEHATAeBglghkgBZQMEAS4wEQQMFDRurM99YtyWFFGVAgEQgDy0P3fNgFINCFlDeS2xXhSIEsw1TS2V3koZ6gdcGmLyt8Zg4v2EH5jePnZ40lfwRZy15pkEIMmjxEtkpyQ='

export KEYSTORE_JKS="$(decrypt "$ENCRYPTED_KEYSTORE_JKS")"
export KEYSTORE_PASSWORD="$(decrypt "$ENCRYPTED_KEYSTORE_PASSWORD")"
export KEY_ALIAS="$(decrypt "$ENCRYPTED_KEY_ALIAS")"
export KEY_PASSWORD="$(decrypt "$ENCRYPTED_KEY_PASSWORD")"
export NEARBY="$(decrypt "$ENCRYPTED_NEARBY")"
export COVERALLS_REPO_TOKEN="$(decrypt "$ENCRYPTED_COVERALLS_REPO_TOKEN")"
export CI_NAME='codepipeline'
export CI_BUILD_NUMBER=$CODEBUILD_RESOLVED_SOURCE_VERSION
export CI='true'

echo "$KEYSTORE_JKS" | base64 --decode > keystore.jks

cat > keystore.properties << EOF
keystorepassword=${KEYSTORE_PASSWORD}
keyalias=${KEY_ALIAS}
keypassword=${KEY_PASSWORD}
EOF

cat > api_keys.properties << EOF
NEARBY=${NEARBY}
EOF

unset KEYSTORE_JKS
unset ENCRYPTED_KEYSTORE_JKS
unset ENCRYPTED_COVERALLS_REPO_TOKEN
unset ENCRYPTED_KEY_ALIAS
unset ENCRYPTED_KEY_PASSWORD
unset ENCRYPTED_NEARBY